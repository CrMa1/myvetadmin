{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///C:/Proyectos/Veterinarios/myvetadmin/lib/db.js"],"sourcesContent":["import mysql from \"mysql2/promise\"\n\n\n// Configuración de la conexión a la base de datos\nconst dbConfig = {\n  host: process.env.DB_HOST || \"174.136.31.150\",\n  user: process.env.DB_USER || \"mavishop_myvetadmin\",\n  password: process.env.DB_PASSWORD || \"KDZ-2y_O#cmI^v7r\",\n  database: process.env.DB_NAME || \"mavishop_myvetadmin\",\n  waitForConnections: true,\n  connectionLimit: 10,\n  queueLimit: 0,\n  enableKeepAlive: true,\n  keepAliveInitialDelay: 0,\n}\n\n// Pool de conexiones para mejor rendimiento\nlet pool\n\nexport async function getConnection() {\n  if (!pool) {\n    pool = mysql.createPool(dbConfig)\n  }\n  return pool\n}\n\nexport async function query(sql, params) {\n  //console.log(\"[v0] Query params:\", params)\n  \n  const connection = await getConnection()\n  try {\n    const [results] = await connection.execute(sql, params)\n    //console.log(\"[v0] Query successful, rows returned:\", Array.isArray(results) ? results.length : \"single result\")\n    return results\n  } catch (error) {\n    console.error(\"[v0] Database query error - Full details:\")\n    console.error(\"[v0] Query:\", sql)\n    console.error(\"[v0] Params:\", params)\n    console.error(\"[v0] Error message:\", error.message)\n    console.error(\"[v0] Error code:\", error.code)\n    console.error(\"[v0] Error sqlState:\", error.sqlState)\n    console.error(\"[v0] Error:\", error)\n    throw error\n  }\n}\n\nexport default { getConnection, query }\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAGA,kDAAkD;AAClD,MAAM,WAAW;IACf,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AACzB;AAEA,4CAA4C;AAC5C,IAAI;AAEG,eAAe;IACpB,IAAI,CAAC,MAAM;QACT,OAAO,8IAAK,CAAC,UAAU,CAAC;IAC1B;IACA,OAAO;AACT;AAEO,eAAe,MAAM,GAAG,EAAE,MAAM;IACrC,2CAA2C;IAE3C,MAAM,aAAa,MAAM;IACzB,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,iHAAiH;QACjH,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC;QACd,QAAQ,KAAK,CAAC,eAAe;QAC7B,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,QAAQ,KAAK,CAAC,uBAAuB,MAAM,OAAO;QAClD,QAAQ,KAAK,CAAC,oBAAoB,MAAM,IAAI;QAC5C,QAAQ,KAAK,CAAC,wBAAwB,MAAM,QAAQ;QACpD,QAAQ,KAAK,CAAC,eAAe;QAC7B,MAAM;IACR;AACF;uCAEe;IAAE;IAAe;AAAM","debugId":null}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///C:/Proyectos/Veterinarios/myvetadmin/app/api/sales/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { query, getConnection } from \"@/lib/db\"\n\nexport async function GET(request) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const userId = searchParams.get(\"userId\")\n    const clinicId = searchParams.get(\"clinicId\")\n\n    if (!userId || !clinicId) {\n      return NextResponse.json({ success: false, error: \"userId y clinicId son requeridos\" }, { status: 400 })\n    }\n\n    const sales = await query(\n      `SELECT s.*, \n        (SELECT JSON_ARRAYAGG(\n          JSON_OBJECT('id', si.inventory_id, 'name', si.item_name, 'quantity', si.quantity, 'price', si.unit_price, 'subtotal', si.subtotal)\n        ) FROM sale_items si WHERE si.sale_id = s.id) as items\n       FROM sales s\n       WHERE s.user_id = ? AND s.clinic_id = ?\n       ORDER BY s.sale_date DESC`,\n      [userId, clinicId],\n    )\n\n    const salesWithItems = sales.map((sale) => ({\n      ...sale,\n      items: sale.items ? JSON.parse(sale.items) : [],\n    }))\n\n    return NextResponse.json({ success: true, data: salesWithItems })\n  } catch (error) {\n    console.error(\"Get sales error:\", error)\n    return NextResponse.json({ success: false, error: \"Error al obtener ventas\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request) {\n  let connection\n\n  try {\n    const body = await request.json()\n\n    if (!body.userId || !body.clinicId) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: \"userId y clinicId son requeridos\",\n        },\n        {\n          status: 400,\n          headers: { \"Content-Type\": \"application/json\" },\n        },\n      )\n    }\n\n    if (!body.items || body.items.length === 0) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: \"La venta debe tener al menos un artículo\",\n        },\n        {\n          status: 400,\n          headers: { \"Content-Type\": \"application/json\" },\n        },\n      )\n    }\n\n    connection = await getConnection()\n    connection = await connection.getConnection()\n    await connection.beginTransaction()\n\n    const saleNumber = `VTA-${new Date().getFullYear()}-${Date.now()}`\n\n    const subtotal = Number.parseFloat(body.subtotal) || 0\n    const tax = Number.parseFloat(body.tax) || 0\n    const discount = Number.parseFloat(body.discount) || 0\n    const total = Number.parseFloat(body.total) || 0\n    const amountPaid = Number.parseFloat(body.amountPaid) || total\n    const change = Number.parseFloat(body.change) || 0\n\n    const [saleResult] = await connection.execute(\n      `INSERT INTO sales (user_id, clinic_id, sale_number, customer_name, subtotal, tax, discount, total, payment_method, amount_paid, change_amount, notes, cashier, sale_date)\n       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())`,\n      [\n        Number.parseInt(body.userId),\n        Number.parseInt(body.clinicId),\n        saleNumber,\n        body.customer || \"Cliente general\",\n        subtotal,\n        tax,\n        discount,\n        total,\n        body.paymentMethod || \"Efectivo\",\n        amountPaid,\n        change,\n        body.notes || null,\n        body.cashier || \"Cajero\",\n      ],\n    )\n\n    const saleId = saleResult.insertId\n\n    const saleItems = []\n\n    for (const item of body.items) {\n\n      const itemPrice = Number.parseFloat(item.price) || 0\n      const itemQuantity = Number.parseInt(item.quantity) || 1\n      const itemSubtotal = itemPrice * itemQuantity\n\n      await connection.execute(\n        `INSERT INTO sale_items (sale_id, inventory_id, item_name, quantity, unit_price, subtotal)\n         VALUES (?, ?, ?, ?, ?, ?)`,\n        [saleId, Number.parseInt(item.id), item.name, itemQuantity, itemPrice, itemSubtotal],\n      )\n\n      saleItems.push({\n        id: Number.parseInt(item.id),\n        name: item.name,\n        quantity: itemQuantity,\n        price: itemPrice,\n        subtotal: itemSubtotal,\n      })\n\n      await connection.execute(\n        \"UPDATE inventory SET stock = stock - ? WHERE id = ? AND user_id = ? AND clinic_id = ?\",\n        [itemQuantity, Number.parseInt(item.id), Number.parseInt(body.userId), Number.parseInt(body.clinicId)],\n      )\n    }\n\n    await connection.execute(\n      `INSERT INTO accounting (user_id, clinic_id, type, category_id, amount, description, transaction_date, payment_method)\n       VALUES (?, ?, ?, ?, ?, ?, CURDATE(), ?)`,\n      [\n        Number.parseInt(body.userId),\n        Number.parseInt(body.clinicId),\n        \"Ingreso\",\n        1,\n        total,\n        `Venta ${saleNumber}`,\n        body.paymentMethod || \"Efectivo\",\n      ],\n    )\n\n    await connection.commit()\n\n    const saleData = {\n      id: saleId,\n      saleNumber: saleNumber,\n      customerName: body.customer || \"Cliente general\",\n      subtotal: subtotal,\n      tax: tax,\n      discount: discount,\n      total: total,\n      paymentMethod: body.paymentMethod || \"Efectivo\",\n      amountPaid: amountPaid,\n      changeAmount: change,\n      cashier: body.cashier || \"Cajero\",\n      saleDate: new Date().toISOString(),\n      items: saleItems,\n    }\n\n    return NextResponse.json(\n      {\n        success: true,\n        data: saleData,\n        message: \"Venta procesada exitosamente\",\n      },\n      {\n        status: 200,\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n      },\n    )\n  } catch (error) {\n    if (connection) {\n      try {\n        await connection.rollback()\n      } catch (rollbackError) {\n        console.error(\"Rollback error:\", rollbackError)\n      }\n    }\n\n    return NextResponse.json(\n      {\n        success: false,\n        error: error.message || \"Error al procesar venta\",\n        details: process.env.NODE_ENV === \"development\" ? error.stack : undefined,\n      },\n      {\n        status: 500,\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n      },\n    )\n  } finally {\n    if (connection) {\n      try {\n        connection.release()\n      } catch (releaseError) {\n        console.error(\"[v0] Connection release error:\", releaseError)\n      }\n    }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}