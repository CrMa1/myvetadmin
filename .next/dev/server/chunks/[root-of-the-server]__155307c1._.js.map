{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///C:/Proyectos/Veterinarios/myvetadmin/lib/db.js"],"sourcesContent":["import mysql from \"mysql2/promise\"\n\n\n// Configuración de la conexión a la base de datos\nconst dbConfig = {\n  host: process.env.DB_HOST || \"174.136.31.150\",\n  user: process.env.DB_USER || \"mavishop_myvetadmin\",\n  password: process.env.DB_PASSWORD || \"KDZ-2y_O#cmI^v7r\",\n  database: process.env.DB_NAME || \"mavishop_myvetadmin\",\n  waitForConnections: true,\n  connectionLimit: 10,\n  queueLimit: 0,\n  enableKeepAlive: true,\n  keepAliveInitialDelay: 0,\n}\n\n// Pool de conexiones para mejor rendimiento\nlet pool\n\nexport async function getConnection() {\n  if (!pool) {\n    pool = mysql.createPool(dbConfig)\n  }\n  return pool\n}\n\nexport async function query(sql, params) {\n  //console.log(\"[v0] Query params:\", params)\n  \n  const connection = await getConnection()\n  try {\n    const [results] = await connection.execute(sql, params)\n    //console.log(\"[v0] Query successful, rows returned:\", Array.isArray(results) ? results.length : \"single result\")\n    return results\n  } catch (error) {\n    console.error(\"[v0] Database query error - Full details:\")\n    console.error(\"[v0] Query:\", sql)\n    console.error(\"[v0] Params:\", params)\n    console.error(\"[v0] Error message:\", error.message)\n    console.error(\"[v0] Error code:\", error.code)\n    console.error(\"[v0] Error sqlState:\", error.sqlState)\n    console.error(\"[v0] Error:\", error)\n    throw error\n  }\n}\n\nexport default { getConnection, query }\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAGA,kDAAkD;AAClD,MAAM,WAAW;IACf,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AACzB;AAEA,4CAA4C;AAC5C,IAAI;AAEG,eAAe;IACpB,IAAI,CAAC,MAAM;QACT,OAAO,8IAAK,CAAC,UAAU,CAAC;IAC1B;IACA,OAAO;AACT;AAEO,eAAe,MAAM,GAAG,EAAE,MAAM;IACrC,2CAA2C;IAE3C,MAAM,aAAa,MAAM;IACzB,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,iHAAiH;QACjH,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC;QACd,QAAQ,KAAK,CAAC,eAAe;QAC7B,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,QAAQ,KAAK,CAAC,uBAAuB,MAAM,OAAO;QAClD,QAAQ,KAAK,CAAC,oBAAoB,MAAM,IAAI;QAC5C,QAAQ,KAAK,CAAC,wBAAwB,MAAM,QAAQ;QACpD,QAAQ,KAAK,CAAC,eAAe;QAC7B,MAAM;IACR;AACF;uCAEe;IAAE;IAAe;AAAM","debugId":null}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///C:/Proyectos/Veterinarios/myvetadmin/app/api/dashboard/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\n\nexport async function GET(request) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const userId = searchParams.get(\"userId\")\n    const clinicId = searchParams.get(\"clinicId\")\n    const startDate = searchParams.get(\"startDate\")\n    const endDate = searchParams.get(\"endDate\")\n\n    if (!userId || !clinicId) {\n      return NextResponse.json({ success: false, error: \"userId y clinicId son requeridos\" }, { status: 400 })\n    }\n\n    let dateCondition = \"\"\n    const params = [userId, clinicId]\n\n    if (startDate && endDate) {\n      dateCondition = \"AND transaction_date BETWEEN ? AND ?\"\n      params.push(startDate, endDate)\n    } else {\n      dateCondition = \"AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)\"\n    }\n\n    const [revenueResult] = await query(\n      `SELECT COALESCE(SUM(amount), 0) as total \n       FROM accounting \n       WHERE type = 'Ingreso' AND user_id = ? AND clinic_id = ? ${dateCondition}`,\n      params,\n    )\n\n    // Prepare params for consultation queries\n    const consultationParams = [userId, clinicId]\n    let consultationDateCondition = \"\"\n\n    if (startDate && endDate) {\n      consultationDateCondition = \"AND consultation_date BETWEEN ? AND ?\"\n      consultationParams.push(startDate, endDate)\n    } else {\n      consultationDateCondition = \"AND consultation_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)\"\n    }\n\n    const [consultationRevenueResult] = await query(\n      `SELECT COALESCE(SUM(cost), 0) as total \n       FROM consultations \n       WHERE status = 'Completada' AND user_id = ? AND clinic_id = ? ${consultationDateCondition}`,\n      consultationParams,\n    )\n\n    const [expensesResult] = await query(\n      `SELECT COALESCE(SUM(amount), 0) as total \n       FROM accounting \n       WHERE type = 'Egreso' AND user_id = ? AND clinic_id = ? ${dateCondition}`,\n      params,\n    )\n\n    const [appointmentsResult] = await query(\n      `SELECT COUNT(*) as count \n       FROM consultations \n       WHERE status = 'Programada' AND user_id = ? AND clinic_id = ? AND consultation_date >= NOW()`,\n      [userId, clinicId],\n    )\n\n    const [patientsResult] = await query(\n      \"SELECT COUNT(*) as count FROM patients WHERE user_id = ? AND clinic_id = ? AND client_id IS NOT NULL\",\n      [userId, clinicId],\n    )\n\n    const salesData = await query(\n      `SELECT DATE(transaction_date) as date, SUM(amount) as revenue\n       FROM accounting\n       WHERE type = 'Ingreso' AND user_id = ? AND clinic_id = ? ${dateCondition}\n       GROUP BY DATE(transaction_date)\n       ORDER BY date ASC`,\n      params,\n    )\n\n    const consultationSalesData = await query(\n      `SELECT DATE(consultation_date) as date, SUM(cost) as revenue\n       FROM consultations\n       WHERE status = 'Completada' AND user_id = ? AND clinic_id = ? ${consultationDateCondition}\n       GROUP BY DATE(consultation_date)\n       ORDER BY date ASC`,\n      consultationParams,\n    )\n\n    const mergedSalesData = {}\n    salesData.forEach((row) => {\n      const dateStr = row.date instanceof Date ? row.date.toISOString().split(\"T\")[0] : row.date\n      mergedSalesData[dateStr] = (mergedSalesData[dateStr] || 0) + (Number.parseFloat(row.revenue) || 0)\n    })\n    consultationSalesData.forEach((row) => {\n      const dateStr = row.date instanceof Date ? row.date.toISOString().split(\"T\")[0] : row.date\n      mergedSalesData[dateStr] = (mergedSalesData[dateStr] || 0) + (Number.parseFloat(row.revenue) || 0)\n    })\n\n    const incomeExpenseData = await query(\n      `SELECT \n        WEEK(transaction_date) as week,\n        YEAR(transaction_date) as year,\n        SUM(CASE WHEN type = 'Ingreso' THEN amount ELSE 0 END) as income,\n        SUM(CASE WHEN type = 'Egreso' THEN amount ELSE 0 END) as expenses\n       FROM accounting\n       WHERE user_id = ? AND clinic_id = ? ${dateCondition}\n       GROUP BY WEEK(transaction_date), YEAR(transaction_date)\n       ORDER BY year ASC, week ASC\n       LIMIT 8`,\n      params,\n    )\n\n    const consultationIncomeByWeek = await query(\n      `SELECT \n        WEEK(consultation_date) as week,\n        YEAR(consultation_date) as year,\n        SUM(cost) as income\n       FROM consultations\n       WHERE status = 'Completada' AND user_id = ? AND clinic_id = ? ${consultationDateCondition}\n       GROUP BY WEEK(consultation_date), YEAR(consultation_date)\n       ORDER BY year ASC, week ASC`,\n      consultationParams,\n    )\n\n    const mergedIncomeExpenseData = {}\n    incomeExpenseData.forEach((row) => {\n      const key = `${row.year}-${row.week}`\n      mergedIncomeExpenseData[key] = {\n        week: row.week,\n        year: row.year,\n        income: Number.parseFloat(row.income) || 0,\n        expenses: Number.parseFloat(row.expenses) || 0,\n      }\n    })\n    consultationIncomeByWeek.forEach((row) => {\n      const key = `${row.year}-${row.week}`\n      if (mergedIncomeExpenseData[key]) {\n        mergedIncomeExpenseData[key].income += Number.parseFloat(row.income) || 0\n      } else {\n        mergedIncomeExpenseData[key] = {\n          week: row.week,\n          year: row.year,\n          income: Number.parseFloat(row.income) || 0,\n          expenses: 0,\n        }\n      }\n    })\n\n    const appointments = await query(\n      `SELECT c.*, p.name as patient_name, CONCAT(cl.first_name, ' ', cl.last_name) as owner_name, s.name as species_name\n       FROM consultations c\n       LEFT JOIN patients p ON c.patient_id = p.id\n       LEFT JOIN clients cl ON p.client_id = cl.id\n       LEFT JOIN species s ON p.species_id = s.id\n       WHERE c.user_id = ? AND c.clinic_id = ? AND c.consultation_date >= NOW() \n       ORDER BY c.consultation_date ASC \n       LIMIT 5`,\n      [userId, clinicId],\n    )\n\n    const accountingRevenue = Number.parseFloat(revenueResult.total) || 0\n    const consultationRevenue = Number.parseFloat(consultationRevenueResult.total) || 0\n    const totalRevenue = accountingRevenue + consultationRevenue\n    const totalExpenses = Number.parseFloat(expensesResult.total) || 0\n\n    const responseData = {\n      success: true,\n      data: {\n        metrics: {\n          totalRevenue,\n          totalExpenses,\n          netIncome: totalRevenue - totalExpenses,\n          scheduledAppointments: appointmentsResult.count || 0,\n          activePatients: patientsResult.count || 0,\n        },\n        salesData: Object.keys(mergedSalesData)\n          .sort()\n          .map((date) => ({\n            date,\n            revenue: mergedSalesData[date],\n          })),\n        incomeExpenseData: Object.values(mergedIncomeExpenseData)\n          .sort((a, b) => {\n            if (a.year !== b.year) return a.year - b.year\n            return a.week - b.week\n          })\n          .slice(-8)\n          .map((row) => ({\n            week: `Semana ${row.week}`,\n            income: row.income,\n            expenses: row.expenses,\n          })),\n        appointments: appointments.map((apt) => ({\n          id: apt.id,\n          patientName: apt.patient_name,\n          ownerName: apt.owner_name,\n          species: apt.species_name,\n          reason: apt.reason,\n          date: apt.consultation_date,\n          status: apt.status,\n        })),\n      },\n    }\n\n    return NextResponse.json(responseData)\n  } catch (error) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: \"Error al obtener datos del dashboard\",\n        details: process.env.NODE_ENV === \"development\" ? error.message : undefined,\n      },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,IAAI,OAAO;IAC/B,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,YAAY,aAAa,GAAG,CAAC;QACnC,MAAM,UAAU,aAAa,GAAG,CAAC;QAEjC,IAAI,CAAC,UAAU,CAAC,UAAU;YACxB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAmC,GAAG;gBAAE,QAAQ;YAAI;QACxG;QAEA,IAAI,gBAAgB;QACpB,MAAM,SAAS;YAAC;YAAQ;SAAS;QAEjC,IAAI,aAAa,SAAS;YACxB,gBAAgB;YAChB,OAAO,IAAI,CAAC,WAAW;QACzB,OAAO;YACL,gBAAgB;QAClB;QAEA,MAAM,CAAC,cAAc,GAAG,MAAM,IAAA,oHAAK,EACjC,CAAC;;gEAEyD,EAAE,eAAe,EAC3E;QAGF,0CAA0C;QAC1C,MAAM,qBAAqB;YAAC;YAAQ;SAAS;QAC7C,IAAI,4BAA4B;QAEhC,IAAI,aAAa,SAAS;YACxB,4BAA4B;YAC5B,mBAAmB,IAAI,CAAC,WAAW;QACrC,OAAO;YACL,4BAA4B;QAC9B;QAEA,MAAM,CAAC,0BAA0B,GAAG,MAAM,IAAA,oHAAK,EAC7C,CAAC;;qEAE8D,EAAE,2BAA2B,EAC5F;QAGF,MAAM,CAAC,eAAe,GAAG,MAAM,IAAA,oHAAK,EAClC,CAAC;;+DAEwD,EAAE,eAAe,EAC1E;QAGF,MAAM,CAAC,mBAAmB,GAAG,MAAM,IAAA,oHAAK,EACtC,CAAC;;mGAE4F,CAAC,EAC9F;YAAC;YAAQ;SAAS;QAGpB,MAAM,CAAC,eAAe,GAAG,MAAM,IAAA,oHAAK,EAClC,wGACA;YAAC;YAAQ;SAAS;QAGpB,MAAM,YAAY,MAAM,IAAA,oHAAK,EAC3B,CAAC;;gEAEyD,EAAE,cAAc;;wBAExD,CAAC,EACnB;QAGF,MAAM,wBAAwB,MAAM,IAAA,oHAAK,EACvC,CAAC;;qEAE8D,EAAE,0BAA0B;;wBAEzE,CAAC,EACnB;QAGF,MAAM,kBAAkB,CAAC;QACzB,UAAU,OAAO,CAAC,CAAC;YACjB,MAAM,UAAU,IAAI,IAAI,YAAY,OAAO,IAAI,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,GAAG,IAAI,IAAI;YAC1F,eAAe,CAAC,QAAQ,GAAG,CAAC,eAAe,CAAC,QAAQ,IAAI,CAAC,IAAI,CAAC,OAAO,UAAU,CAAC,IAAI,OAAO,KAAK,CAAC;QACnG;QACA,sBAAsB,OAAO,CAAC,CAAC;YAC7B,MAAM,UAAU,IAAI,IAAI,YAAY,OAAO,IAAI,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,GAAG,IAAI,IAAI;YAC1F,eAAe,CAAC,QAAQ,GAAG,CAAC,eAAe,CAAC,QAAQ,IAAI,CAAC,IAAI,CAAC,OAAO,UAAU,CAAC,IAAI,OAAO,KAAK,CAAC;QACnG;QAEA,MAAM,oBAAoB,MAAM,IAAA,oHAAK,EACnC,CAAC;;;;;;2CAMoC,EAAE,cAAc;;;cAG7C,CAAC,EACT;QAGF,MAAM,2BAA2B,MAAM,IAAA,oHAAK,EAC1C,CAAC;;;;;qEAK8D,EAAE,0BAA0B;;kCAE/D,CAAC,EAC7B;QAGF,MAAM,0BAA0B,CAAC;QACjC,kBAAkB,OAAO,CAAC,CAAC;YACzB,MAAM,MAAM,GAAG,IAAI,IAAI,CAAC,CAAC,EAAE,IAAI,IAAI,EAAE;YACrC,uBAAuB,CAAC,IAAI,GAAG;gBAC7B,MAAM,IAAI,IAAI;gBACd,MAAM,IAAI,IAAI;gBACd,QAAQ,OAAO,UAAU,CAAC,IAAI,MAAM,KAAK;gBACzC,UAAU,OAAO,UAAU,CAAC,IAAI,QAAQ,KAAK;YAC/C;QACF;QACA,yBAAyB,OAAO,CAAC,CAAC;YAChC,MAAM,MAAM,GAAG,IAAI,IAAI,CAAC,CAAC,EAAE,IAAI,IAAI,EAAE;YACrC,IAAI,uBAAuB,CAAC,IAAI,EAAE;gBAChC,uBAAuB,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,UAAU,CAAC,IAAI,MAAM,KAAK;YAC1E,OAAO;gBACL,uBAAuB,CAAC,IAAI,GAAG;oBAC7B,MAAM,IAAI,IAAI;oBACd,MAAM,IAAI,IAAI;oBACd,QAAQ,OAAO,UAAU,CAAC,IAAI,MAAM,KAAK;oBACzC,UAAU;gBACZ;YACF;QACF;QAEA,MAAM,eAAe,MAAM,IAAA,oHAAK,EAC9B,CAAC;;;;;;;cAOO,CAAC,EACT;YAAC;YAAQ;SAAS;QAGpB,MAAM,oBAAoB,OAAO,UAAU,CAAC,cAAc,KAAK,KAAK;QACpE,MAAM,sBAAsB,OAAO,UAAU,CAAC,0BAA0B,KAAK,KAAK;QAClF,MAAM,eAAe,oBAAoB;QACzC,MAAM,gBAAgB,OAAO,UAAU,CAAC,eAAe,KAAK,KAAK;QAEjE,MAAM,eAAe;YACnB,SAAS;YACT,MAAM;gBACJ,SAAS;oBACP;oBACA;oBACA,WAAW,eAAe;oBAC1B,uBAAuB,mBAAmB,KAAK,IAAI;oBACnD,gBAAgB,eAAe,KAAK,IAAI;gBAC1C;gBACA,WAAW,OAAO,IAAI,CAAC,iBACpB,IAAI,GACJ,GAAG,CAAC,CAAC,OAAS,CAAC;wBACd;wBACA,SAAS,eAAe,CAAC,KAAK;oBAChC,CAAC;gBACH,mBAAmB,OAAO,MAAM,CAAC,yBAC9B,IAAI,CAAC,CAAC,GAAG;oBACR,IAAI,EAAE,IAAI,KAAK,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,GAAG,EAAE,IAAI;oBAC7C,OAAO,EAAE,IAAI,GAAG,EAAE,IAAI;gBACxB,GACC,KAAK,CAAC,CAAC,GACP,GAAG,CAAC,CAAC,MAAQ,CAAC;wBACb,MAAM,CAAC,OAAO,EAAE,IAAI,IAAI,EAAE;wBAC1B,QAAQ,IAAI,MAAM;wBAClB,UAAU,IAAI,QAAQ;oBACxB,CAAC;gBACH,cAAc,aAAa,GAAG,CAAC,CAAC,MAAQ,CAAC;wBACvC,IAAI,IAAI,EAAE;wBACV,aAAa,IAAI,YAAY;wBAC7B,WAAW,IAAI,UAAU;wBACzB,SAAS,IAAI,YAAY;wBACzB,QAAQ,IAAI,MAAM;wBAClB,MAAM,IAAI,iBAAiB;wBAC3B,QAAQ,IAAI,MAAM;oBACpB,CAAC;YACH;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO;YACP,SAAS,uCAAyC,MAAM,OAAO,GAAG;QACpE,GACA;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}