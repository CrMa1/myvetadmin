{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///C:/Proyectos/Veterinarios/myvetadmin/lib/db.js"],"sourcesContent":["import mysql from \"mysql2/promise\"\n\n\n// Configuración de la conexión a la base de datos\nconst dbConfig = {\n  host: process.env.DB_HOST || \"174.136.31.150\",\n  user: process.env.DB_USER || \"mavishop_myvetadmin\",\n  password: process.env.DB_PASSWORD || \"KDZ-2y_O#cmI^v7r\",\n  database: process.env.DB_NAME || \"mavishop_myvetadmin\",\n  waitForConnections: true,\n  connectionLimit: 10,\n  queueLimit: 0,\n  enableKeepAlive: true,\n  keepAliveInitialDelay: 0,\n}\n\n// Pool de conexiones para mejor rendimiento\nlet pool\n\nexport async function getConnection() {\n  if (!pool) {\n    pool = mysql.createPool(dbConfig)\n  }\n  return pool\n}\n\nexport async function query(sql, params) {\n  //console.log(\"[v0] Query params:\", params)\n  \n  const connection = await getConnection()\n  try {\n    const [results] = await connection.execute(sql, params)\n    //console.log(\"[v0] Query successful, rows returned:\", Array.isArray(results) ? results.length : \"single result\")\n    return results\n  } catch (error) {\n    //console.error(\"[v0] Database query error - Full details:\")\n    //console.error(\"[v0] Query:\", sql)\n    //console.error(\"[v0] Params:\", params)\n    //console.error(\"[v0] Error message:\", error.message)\n    //console.error(\"[v0] Error code:\", error.code)\n    //console.error(\"[v0] Error sqlState:\", error.sqlState)\n    //console.error(\"[v0] Error:\", error)\n    throw error\n  }\n}\n\nexport default { getConnection, query }\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAGA,kDAAkD;AAClD,MAAM,WAAW;IACf,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AACzB;AAEA,4CAA4C;AAC5C,IAAI;AAEG,eAAe;IACpB,IAAI,CAAC,MAAM;QACT,OAAO,8IAAK,CAAC,UAAU,CAAC;IAC1B;IACA,OAAO;AACT;AAEO,eAAe,MAAM,GAAG,EAAE,MAAM;IACrC,2CAA2C;IAE3C,MAAM,aAAa,MAAM;IACzB,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,iHAAiH;QACjH,OAAO;IACT,EAAE,OAAO,OAAO;QACd,4DAA4D;QAC5D,mCAAmC;QACnC,uCAAuC;QACvC,qDAAqD;QACrD,+CAA+C;QAC/C,uDAAuD;QACvD,qCAAqC;QACrC,MAAM;IACR;AACF;uCAEe;IAAE;IAAe;AAAM","debugId":null}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///C:/Proyectos/Veterinarios/myvetadmin/app/api/dashboard/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\n\nexport async function GET(request) {\n\n  try {\n    const { searchParams } = new URL(request.url)\n    const userId = searchParams.get(\"userId\")\n    const clinicId = searchParams.get(\"clinicId\")\n\n\n    if (!userId || !clinicId) {\n      return NextResponse.json({ success: false, error: \"userId y clinicId son requeridos\" }, { status: 400 })\n    }\n\n    const [revenueResult] = await query(\n      `SELECT COALESCE(SUM(amount), 0) as total \n       FROM accounting \n       WHERE type = 'Ingreso' AND user_id = ? AND clinic_id = ? AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)`,\n      [userId, clinicId],\n    )\n\n    const [expensesResult] = await query(\n      `SELECT COALESCE(SUM(amount), 0) as total \n       FROM accounting \n       WHERE type = 'Egreso' AND user_id = ? AND clinic_id = ? AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)`,\n      [userId, clinicId],\n    )\n\n    const [appointmentsResult] = await query(\n      `SELECT COUNT(*) as count \n       FROM consultations \n       WHERE status = 'Programada' AND user_id = ? AND clinic_id = ? AND consultation_date >= NOW()`,\n      [userId, clinicId],\n    )\n\n    const [patientsResult] = await query(\"SELECT COUNT(*) as count FROM patients WHERE user_id = ? AND clinic_id = ?\", [\n      userId,\n      clinicId,\n    ])\n\n    const salesData = await query(\n      `SELECT DATE(transaction_date) as date, SUM(amount) as revenue\n       FROM accounting\n       WHERE type = 'Ingreso' AND user_id = ? AND clinic_id = ? AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)\n       GROUP BY DATE(transaction_date)\n       ORDER BY date ASC`,\n      [userId, clinicId],\n    )\n\n    const incomeExpenseData = await query(\n      `SELECT \n        WEEK(transaction_date) as week,\n        YEAR(transaction_date) as year,\n        SUM(CASE WHEN type = 'Ingreso' THEN amount ELSE 0 END) as income,\n        SUM(CASE WHEN type = 'Egreso' THEN amount ELSE 0 END) as expenses\n       FROM accounting\n       WHERE user_id = ? AND clinic_id = ? AND transaction_date >= DATE_SUB(CURDATE(), INTERVAL 60 DAY)\n       GROUP BY WEEK(transaction_date), YEAR(transaction_date)\n       ORDER BY year ASC, week ASC\n       LIMIT 8`,\n      [userId, clinicId],\n    )\n\n    const appointments = await query(\n      `SELECT c.*, p.name as patient_name, p.owner as owner_name, s.name as species_name\n       FROM consultations c\n       LEFT JOIN patients p ON c.patient_id = p.id\n       LEFT JOIN species s ON p.species_id = s.id\n       WHERE c.user_id = ? AND c.clinic_id = ? AND c.consultation_date >= NOW() \n       ORDER BY c.consultation_date ASC \n       LIMIT 5`,\n      [userId, clinicId],\n    )\n\n    const totalRevenue = Number.parseFloat(revenueResult.total) || 0\n    const totalExpenses = Number.parseFloat(expensesResult.total) || 0\n\n    const responseData = {\n      success: true,\n      data: {\n        metrics: {\n          totalRevenue,\n          totalExpenses,\n          netIncome: totalRevenue - totalExpenses,\n          scheduledAppointments: appointmentsResult.count || 0,\n          activePatients: patientsResult.count || 0,\n        },\n        salesData: salesData.map((row) => ({\n          date: row.date,\n          revenue: Number.parseFloat(row.revenue) || 0,\n        })),\n        incomeExpenseData: incomeExpenseData.map((row) => ({\n          week: `Semana ${row.week}`,\n          income: Number.parseFloat(row.income) || 0,\n          expenses: Number.parseFloat(row.expenses) || 0,\n        })),\n        appointments: appointments.map((apt) => ({\n          id: apt.id,\n          patientName: apt.patient_name,\n          ownerName: apt.owner_name,\n          species: apt.species_name,\n          reason: apt.reason,\n          date: apt.consultation_date,\n          status: apt.status,\n        })),\n      },\n    }\n\n    return NextResponse.json(responseData)\n  } catch (error) {\n\n    return NextResponse.json(\n      {\n        success: false,\n        error: \"Error al obtener datos del dashboard\",\n        details: process.env.NODE_ENV === \"development\" ? error.message : undefined,\n      },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,IAAI,OAAO;IAE/B,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,WAAW,aAAa,GAAG,CAAC;QAGlC,IAAI,CAAC,UAAU,CAAC,UAAU;YACxB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAmC,GAAG;gBAAE,QAAQ;YAAI;QACxG;QAEA,MAAM,CAAC,cAAc,GAAG,MAAM,IAAA,oHAAK,EACjC,CAAC;;4HAEqH,CAAC,EACvH;YAAC;YAAQ;SAAS;QAGpB,MAAM,CAAC,eAAe,GAAG,MAAM,IAAA,oHAAK,EAClC,CAAC;;2HAEoH,CAAC,EACtH;YAAC;YAAQ;SAAS;QAGpB,MAAM,CAAC,mBAAmB,GAAG,MAAM,IAAA,oHAAK,EACtC,CAAC;;mGAE4F,CAAC,EAC9F;YAAC;YAAQ;SAAS;QAGpB,MAAM,CAAC,eAAe,GAAG,MAAM,IAAA,oHAAK,EAAC,8EAA8E;YACjH;YACA;SACD;QAED,MAAM,YAAY,MAAM,IAAA,oHAAK,EAC3B,CAAC;;;;wBAIiB,CAAC,EACnB;YAAC;YAAQ;SAAS;QAGpB,MAAM,oBAAoB,MAAM,IAAA,oHAAK,EACnC,CAAC;;;;;;;;;cASO,CAAC,EACT;YAAC;YAAQ;SAAS;QAGpB,MAAM,eAAe,MAAM,IAAA,oHAAK,EAC9B,CAAC;;;;;;cAMO,CAAC,EACT;YAAC;YAAQ;SAAS;QAGpB,MAAM,eAAe,OAAO,UAAU,CAAC,cAAc,KAAK,KAAK;QAC/D,MAAM,gBAAgB,OAAO,UAAU,CAAC,eAAe,KAAK,KAAK;QAEjE,MAAM,eAAe;YACnB,SAAS;YACT,MAAM;gBACJ,SAAS;oBACP;oBACA;oBACA,WAAW,eAAe;oBAC1B,uBAAuB,mBAAmB,KAAK,IAAI;oBACnD,gBAAgB,eAAe,KAAK,IAAI;gBAC1C;gBACA,WAAW,UAAU,GAAG,CAAC,CAAC,MAAQ,CAAC;wBACjC,MAAM,IAAI,IAAI;wBACd,SAAS,OAAO,UAAU,CAAC,IAAI,OAAO,KAAK;oBAC7C,CAAC;gBACD,mBAAmB,kBAAkB,GAAG,CAAC,CAAC,MAAQ,CAAC;wBACjD,MAAM,CAAC,OAAO,EAAE,IAAI,IAAI,EAAE;wBAC1B,QAAQ,OAAO,UAAU,CAAC,IAAI,MAAM,KAAK;wBACzC,UAAU,OAAO,UAAU,CAAC,IAAI,QAAQ,KAAK;oBAC/C,CAAC;gBACD,cAAc,aAAa,GAAG,CAAC,CAAC,MAAQ,CAAC;wBACvC,IAAI,IAAI,EAAE;wBACV,aAAa,IAAI,YAAY;wBAC7B,WAAW,IAAI,UAAU;wBACzB,SAAS,IAAI,YAAY;wBACzB,QAAQ,IAAI,MAAM;wBAClB,MAAM,IAAI,iBAAiB;wBAC3B,QAAQ,IAAI,MAAM;oBACpB,CAAC;YACH;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QAEd,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO;YACP,SAAS,uCAAyC,MAAM,OAAO,GAAG;QACpE,GACA;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}