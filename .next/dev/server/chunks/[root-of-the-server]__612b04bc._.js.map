{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///C:/Proyectos/Veterinarios/myvetadmin/lib/db.js"],"sourcesContent":["import mysql from \"mysql2/promise\"\n\n\n// Configuración de la conexión a la base de datos\nconst dbConfig = {\n  host: process.env.DB_HOST || \"174.136.31.150\",\n  user: process.env.DB_USER || \"mavishop_myvetadmin\",\n  password: process.env.DB_PASSWORD || \"KDZ-2y_O#cmI^v7r\",\n  database: process.env.DB_NAME || \"mavishop_myvetadmin\",\n  waitForConnections: true,\n  connectionLimit: 10,\n  queueLimit: 0,\n  enableKeepAlive: true,\n  keepAliveInitialDelay: 0,\n}\n\n// Pool de conexiones para mejor rendimiento\nlet pool\n\nexport async function getConnection() {\n  if (!pool) {\n    pool = mysql.createPool(dbConfig)\n  }\n  return pool\n}\n\nexport async function query(sql, params) {\n  //console.log(\"[v0] Query params:\", params)\n  \n  const connection = await getConnection()\n  try {\n    const [results] = await connection.execute(sql, params)\n    //console.log(\"[v0] Query successful, rows returned:\", Array.isArray(results) ? results.length : \"single result\")\n    return results\n  } catch (error) {\n    console.error(\"[v0] Database query error - Full details:\")\n    console.error(\"[v0] Query:\", sql)\n    console.error(\"[v0] Params:\", params)\n    console.error(\"[v0] Error message:\", error.message)\n    console.error(\"[v0] Error code:\", error.code)\n    console.error(\"[v0] Error sqlState:\", error.sqlState)\n    console.error(\"[v0] Error:\", error)\n    throw error\n  }\n}\n\nexport default { getConnection, query }\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAGA,kDAAkD;AAClD,MAAM,WAAW;IACf,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AACzB;AAEA,4CAA4C;AAC5C,IAAI;AAEG,eAAe;IACpB,IAAI,CAAC,MAAM;QACT,OAAO,8IAAK,CAAC,UAAU,CAAC;IAC1B;IACA,OAAO;AACT;AAEO,eAAe,MAAM,GAAG,EAAE,MAAM;IACrC,2CAA2C;IAE3C,MAAM,aAAa,MAAM;IACzB,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,iHAAiH;QACjH,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC;QACd,QAAQ,KAAK,CAAC,eAAe;QAC7B,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,QAAQ,KAAK,CAAC,uBAAuB,MAAM,OAAO;QAClD,QAAQ,KAAK,CAAC,oBAAoB,MAAM,IAAI;QAC5C,QAAQ,KAAK,CAAC,wBAAwB,MAAM,QAAQ;QACpD,QAAQ,KAAK,CAAC,eAAe;QAC7B,MAAM;IACR;AACF;uCAEe;IAAE;IAAe;AAAM","debugId":null}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///C:/Proyectos/Veterinarios/myvetadmin/app/api/auth/login/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport bcrypt from \"bcryptjs\"\nimport crypto from \"crypto\"\n\nexport async function POST(request) {\n  try {\n    const { email, password } = await request.json()\n\n    const userAgent = request.headers.get(\"user-agent\") || \"Unknown\"\n    const ipAddress = request.headers.get(\"x-forwarded-for\") || request.headers.get(\"x-real-ip\") || \"Unknown\"\n\n    const users = await query(\"SELECT * FROM users WHERE email = ?\", [email])\n\n    if (users.length === 0) {\n      return NextResponse.json({ success: false, error: \"Usuario no encontrado\" }, { status: 404 })\n    }\n\n    const user = users[0]\n\n    const isValidPassword = await bcrypt.compare(password, user.password)\n\n    if (!isValidPassword) {\n      return NextResponse.json({ success: false, error: \"Contraseña incorrecta\" }, { status: 401 })\n    }\n\n    const planLimits = await query(\"SELECT * FROM plan_limits WHERE plan_id = ?\", [user.plan_id || 1])\n\n    if (planLimits.length === 0) {\n      return NextResponse.json({ success: false, error: \"Plan no válido. Contacte al administrador.\" }, { status: 400 })\n    }\n\n    const limits = planLimits[0]\n\n    const activeSessions = await query(\n      `SELECT COUNT(*) as count FROM user_sessions \n       WHERE user_id = ? AND last_activity > DATE_SUB(NOW(), INTERVAL 30 MINUTE)`,\n      [user.id],\n    )\n\n    const activeSessionCount = activeSessions[0].count\n\n    if (limits.max_devices && activeSessionCount >= limits.max_devices) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: `Tu plan permite un máximo de ${limits.max_devices} dispositivo(s) conectado(s) simultáneamente. Actualmente tienes ${activeSessionCount} sesión(es) activa(s). Por favor, cierra sesión en otro dispositivo o actualiza tu plan.`,\n          message: `Tu plan permite un máximo de ${limits.max_devices} dispositivo(s) conectado(s) simultáneamente. Actualmente tienes ${activeSessionCount} sesión(es) activa(s). Por favor, cierra sesión en otro dispositivo o actualiza tu plan.`,\n          code: \"MAX_DEVICES_REACHED\",\n          data: {\n            currentSessions: activeSessionCount,\n            maxDevices: limits.max_devices,\n          },\n        },\n        { status: 403 },\n      )\n    }\n\n    const sessionToken = crypto.randomBytes(64).toString(\"hex\")\n\n    await query(\n      `INSERT INTO user_sessions (user_id, session_token, device_info, ip_address, user_agent, expires_at)\n       VALUES (?, ?, ?, ?, ?, DATE_ADD(NOW(), INTERVAL 24 HOUR))`,\n      [user.id, sessionToken, `${userAgent.substring(0, 100)}`, ipAddress, userAgent],\n    )\n\n    await query(\"UPDATE users SET session_active = 1 WHERE id = ?\", [user.id])\n\n    const clinics = await query(\"SELECT * FROM clinics WHERE user_id = ?\", [user.id])\n\n    const planFeatures = await query(\n      \"SELECT feature_code, feature_name, is_enabled FROM plan_features WHERE plan_id = ?\",\n      [user.plan_id || 1],\n    )\n\n    // Don't send password back to client\n    const { password: _, ...userWithoutPassword } = user\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        ...userWithoutPassword,\n        clinics: clinics,\n        sessionToken: sessionToken,\n        planLimits: limits,\n        planFeatures: planFeatures,\n      },\n      message: \"Inicio de sesión exitoso\",\n    })\n  } catch (error) {\n    console.error(\"Login error:\", error)\n    return NextResponse.json({ success: false, error: \"Error al iniciar sesión\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,KAAK,OAAO;IAChC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE9C,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,iBAAiB;QACvD,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB,QAAQ,OAAO,CAAC,GAAG,CAAC,gBAAgB;QAEhG,MAAM,QAAQ,MAAM,IAAA,oHAAK,EAAC,uCAAuC;YAAC;SAAM;QAExE,IAAI,MAAM,MAAM,KAAK,GAAG;YACtB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7F;QAEA,MAAM,OAAO,KAAK,CAAC,EAAE;QAErB,MAAM,kBAAkB,MAAM,8IAAM,CAAC,OAAO,CAAC,UAAU,KAAK,QAAQ;QAEpE,IAAI,CAAC,iBAAiB;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7F;QAEA,MAAM,aAAa,MAAM,IAAA,oHAAK,EAAC,+CAA+C;YAAC,KAAK,OAAO,IAAI;SAAE;QAEjG,IAAI,WAAW,MAAM,KAAK,GAAG;YAC3B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAA6C,GAAG;gBAAE,QAAQ;YAAI;QAClH;QAEA,MAAM,SAAS,UAAU,CAAC,EAAE;QAE5B,MAAM,iBAAiB,MAAM,IAAA,oHAAK,EAChC,CAAC;gFACyE,CAAC,EAC3E;YAAC,KAAK,EAAE;SAAC;QAGX,MAAM,qBAAqB,cAAc,CAAC,EAAE,CAAC,KAAK;QAElD,IAAI,OAAO,WAAW,IAAI,sBAAsB,OAAO,WAAW,EAAE;YAClE,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,OAAO,CAAC,6BAA6B,EAAE,OAAO,WAAW,CAAC,iEAAiE,EAAE,mBAAmB,wFAAwF,CAAC;gBACzO,SAAS,CAAC,6BAA6B,EAAE,OAAO,WAAW,CAAC,iEAAiE,EAAE,mBAAmB,wFAAwF,CAAC;gBAC3O,MAAM;gBACN,MAAM;oBACJ,iBAAiB;oBACjB,YAAY,OAAO,WAAW;gBAChC;YACF,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,eAAe,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;QAErD,MAAM,IAAA,oHAAK,EACT,CAAC;gEACyD,CAAC,EAC3D;YAAC,KAAK,EAAE;YAAE;YAAc,GAAG,UAAU,SAAS,CAAC,GAAG,MAAM;YAAE;YAAW;SAAU;QAGjF,MAAM,IAAA,oHAAK,EAAC,oDAAoD;YAAC,KAAK,EAAE;SAAC;QAEzE,MAAM,UAAU,MAAM,IAAA,oHAAK,EAAC,2CAA2C;YAAC,KAAK,EAAE;SAAC;QAEhF,MAAM,eAAe,MAAM,IAAA,oHAAK,EAC9B,sFACA;YAAC,KAAK,OAAO,IAAI;SAAE;QAGrB,qCAAqC;QACrC,MAAM,EAAE,UAAU,CAAC,EAAE,GAAG,qBAAqB,GAAG;QAEhD,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ,GAAG,mBAAmB;gBACtB,SAAS;gBACT,cAAc;gBACd,YAAY;gBACZ,cAAc;YAChB;YACA,SAAS;QACX;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IAC/F;AACF","debugId":null}}]
}